<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script>

      window.onload = function() {
        var url = window.location.search.split('=');
        var directURL = url[1];

        var canvasImg = openImgInCanvas(directURL);

        // opens retrieved image in HTML Canvas element
        function openImgInCanvas(imageURL) {
          var canvas = document.getElementById("image-canvas");
          var ctx = canvas.getContext('2d');
          var img = new Image();
          img.crossOrigin = "anonymous";

          img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img,0,0);

            var pixelationInfo = createPixelationInfo(ctx, img.width, img.height);
            buildPixelatedImg(pixelationInfo);
          }

          img.src = imageURL;
        } // end function

        // generates test image as divs
        function buildPixelatedImg(pixelationInfo) {
          var imgData   = pixelationInfo[0];
          var blockSize = pixelationInfo[1];
          var numCols   = pixelationInfo[2];
          var numRows   = pixelationInfo[3];

          var $grid = $('#grid');
          $('#grid').empty();

          $("#grid").css("width", blockSize * numCols);
          $("#grid").css("height", blockSize * numRows);
          // $("#grid").addClass("border");

          var blockNum = 0;

          for (var row = 0; row < numRows; row++) {
            var $row = $('<div class="grid-row">');

            for (var col = 0; col < numCols; col++) {
              var $block = $('<div class="block">');
              var red = imgData[blockNum][0];
              var green = imgData[blockNum][1];
              var blue = imgData[blockNum][2];

              $block.css("background-color", 'rgb(' + red + ',' + green + ',' + blue + ')');
              $block.css("width", blockSize);
              $block.css("height", blockSize);

              $block.appendTo($row);
              blockNum++;
            }

            $row.appendTo($grid);
          }
        } // end function

        // iterates through all blocks of calculated number of pixels
        function createPixelationInfo(ctx, width, height) {
          var averagedBlocks = [];
          var avgBlockColor = "";
          var numBlocks = 50;
          var blockSize = numRows = numCols = 0;

          if (width > height) {
            blockSize = Math.floor(width / numBlocks);
            numCols = numBlocks;
            numRows = Math.floor(height / blockSize);
          } else {
            blockSize = Math.floor(height / numBlocks);
            numRows = numBlocks;
            numCols = Math.floor(width / blockSize);
          }

          console.log("w, h, blockSize, numBlocks, cols, rows: ",
            width, height, blockSize, numBlocks, numCols, numRows);
          for (var row = 0; row < numRows; row++) {

            for (var col = 0; col < numCols; col++) {
              var imgd = ctx.getImageData(col * blockSize, row * blockSize, blockSize, blockSize);
              var blockData = imgd["data"];

              avgBlockColor = getAvgBlockColor(blockData);
              averagedBlocks.push(avgBlockColor);
            }
          }
          
          return [averagedBlocks, blockSize, numCols, numRows];
        } // end function

        // calculates average color for a block of image pixels
        function getAvgBlockColor(blockData) {
          var red = green = blue = i = count = 0;
          var length = blockData.length;

          while (i < length) {
            red   += blockData[i];
            green += blockData[i+1];
            blue  += blockData[i+2];
            i += 4; // skip a, get next red value
            count++;
          }

          red   = Math.floor(red / count);
          green = Math.floor(green / count);
          blue  = Math.floor(blue / count);

          return [red, green, blue];
        } // end function
      }

    </script>
    <title>Pixelizr</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="css/materialize.min.css">
    <link rel="stylesheet" href="css/styles.css">
  </head>
  <body>
    <!-- <label>Image File:</label><br/>
    <input type="file" id="imageLoader" name="imageLoader"/> -->
    <canvas id="image-canvas"></canvas>
    <div id="grid"></div>
    <script src="js/jquery-2.2.4.min.js"></script>
  </body>
</html>
